<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="lxian's Blog">
<meta property="og:url" content="http://lxian2.space/index.html">
<meta property="og:site_name" content="lxian's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lxian's Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lxian2.space/"/>





  <title> lxian's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-68852515-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lxian's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2016/12/31/简单总结pep333/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/简单总结pep333/" itemprop="url">
                  简单总结pep333
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T17:24:28+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/31/简单总结pep333/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/31/简单总结pep333/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="应用端"><a href="#应用端" class="headerlink" title="应用端"></a>应用端</h4><p>提供一个callable 的object. 它应当接受两个参数<code>environ</code>, <code>start_response</code>。并将response body 以一个iterable object 的形式return。</p>
<ol>
<li>environ<br>包含当前request的各种参数</li>
<li>start_reponse<br>一个callable object, 接受<code>status</code>，<code>response_headers</code>和 <code>exc_info</code>.<br><code>exc_info</code> 是应用将错误传递给网关端用的。<br><code>start_response</code> 作用是写reponse header，所以需在retrun之前调用</li>
<li>return - iterable response body<br>服务器端会读完它并将其写入response</li>
</ol>
<h4 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h4><p>每次request 调用应用端端callable 并传入相应的参数。在应用端调用<code>start_response</code>之后，写header，并在应用端返回后，发送header和body</p>
<h4 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h4><p>对应用端看来它是服务器端，服务器端看来它是应用端。也就是说它需要同时实现应用端和服务器端。<br>所以它需要</p>
<ol>
<li>能接收一个应用端程序，并实现自己的<code>start_response</code>，将服务器端的<code>start_response</code>封装进去</li>
<li>callable 并能接收接收<code>environ</code>, <code>start_response</code>，</li>
<li>在服务器端调用自己的时候，调用应用程序，并且传入自己的<code>start_response</code></li>
</ol>
<p>由上面可以看出，中间件可以在两个地方实现自己的功能</p>
<ol>
<li>在被服务器端调用的时候，可以改写<code>environ</code></li>
<li>在自己封装的<code>start_response</code> 中，可以改写从应用端得到的<code>status</code>, <code>response_headers</code></li>
<li>在应用端返回之后，可以改写应用端返回的reponse body</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2016/07/18/GCD-Overview/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/GCD-Overview/" itemprop="url">
                  GCD Overview
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-18T12:56:55+08:00">
                2016-07-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/07/18/GCD-Overview/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/18/GCD-Overview/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>总结下 GCD.</p>
<h4 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h4><p>CGD 是对线程的抽象。将线程管理交给系统实现，程序员只需要将想执行的任务加入到相应的队列中。</p>
<p>只有global queue 会被调度运行。当创建自己的queue 的时候，实际上会被set target 到global queue 去，custome queue 将要执行的 block 交给 global queue 执行。(存疑，只在一本书上看到这样的描述)</p>
<p>Concurrent Disptach Queue 会由系统来决定应当生成的线程数。而 Serial Dispatch Queue 每创建一条都会创建一条新线程。（大量生成 Serial Queue 会消耗大量内存）</p>
<p>iOS 6.0 之后 GCD 已经加入 ARC, 无需手动释放。</p>
<h4 id="Set-target"><a href="#Set-target" class="headerlink" title="Set target"></a>Set target</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch_set_target(queueA, queueB);</div></pre></td></tr></table></figure>
<p>queueA 将 block 传给 queueB 执行</p>
<h4 id="Suspend-amp-Resume"><a href="#Suspend-amp-Resume" class="headerlink" title="Suspend &amp; Resume"></a>Suspend &amp; Resume</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dispatch_suspend(queue);</div><div class="line">dispatch_resume(queue);</div></pre></td></tr></table></figure>
<p>queue 被 suspend 之后将停止执行队列中的block. (当前block会继续执行到结束)</p>
<h4 id="dispatch-barrier-async"><a href="#dispatch-barrier-async" class="headerlink" title="dispatch_barrier_async"></a>dispatch_barrier_async</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">	<span class="comment">// read blocks one</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">dispatch_barrier_async(queue, ^&#123;</div><div class="line">	<span class="comment">// write block</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">	<span class="comment">// read blocks two</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>dispatch_barrier_async 加入block 之前的 blocks 执行完毕后， 执行 barrier 加入的 block, 完成之后再执行之后加入的 block</p>
<p>case: read block 用普通的 dispatch_async, write block 用 dispatch_barrier_async。比如一个array，可以用这样的方法来保证其线程安全。</p>
<h4 id="dispatch-group"><a href="#dispatch-group" class="headerlink" title="dispatch group"></a>dispatch group</h4><p>将几个block group 起来，全部执行完后通知用户<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dispatch_group_t group = dispatch_group_create();</div><div class="line"></div><div class="line">dispatch_group_async(group, queue, blockA);</div><div class="line">dispatch_group_async(group, queue, blockB);</div><div class="line"></div><div class="line"><span class="comment">// blockC will be executed after blockA and block B finishes</span></div><div class="line">dispatch_group_notify(group, queue, blockC);</div></pre></td></tr></table></figure></p>
<p>dispatch_group_wait 设置等待时间，到时间直接返回，若为0 则全部完成。设置 DISPATCH_TIME_FOREVER 永远等待，DISPTACH_TIME_NOW 立即返回。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> result = dispatch_group_wait(group, time);</div><div class="line"><span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</div><div class="line">	<span class="comment">// all blocks finished executing</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">// some blocks are not finished yet</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="dispatch-apply"><a href="#dispatch-apply" class="headerlink" title="dispatch_apply"></a>dispatch_apply</h4><p>dispatch_sync 的复数版本<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// execute the block on queue 10 times, </span></div><div class="line"><span class="comment">// will block current thread until all blocks are finished</span></div><div class="line">dispatch_apply(<span class="number">10</span>, queue, ^(size_t index)&#123;</div><div class="line">	<span class="comment">// index of the executing times</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="dispatch-semaphore"><a href="#dispatch-semaphore" class="headerlink" title="dispatch semaphore"></a>dispatch semaphore</h4><p>计数信号<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create a semphore with initial count of 10</span></div><div class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="comment">// wait for the chance to reduce 1 to the semaphore</span></div><div class="line"><span class="keyword">long</span> result = dispatch_semaphore_wait(semaphore, time);</div><div class="line"></div><div class="line"><span class="comment">// perform some tasks...</span></div><div class="line"></div><div class="line"><span class="comment">// increacse one to semaphore</span></div><div class="line">dispatch_semaphore_signal(semaphore);</div></pre></td></tr></table></figure></p>
<h4 id="dispatch-once"><a href="#dispatch-once" class="headerlink" title="dispatch_once"></a>dispatch_once</h4><p>略</p>
<h4 id="dispatch-source"><a href="#dispatch-source" class="headerlink" title="dispatch source"></a>dispatch source</h4><h5 id="dispatch-source-data-add"><a href="#dispatch-source-data-add" class="headerlink" title="dispatch source data add"></a>dispatch source data add</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_DATA_ADD,</div><div class="line">							<span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line"></div><div class="line"><span class="comment">// add handler to the source 			</span></div><div class="line">__block <span class="keyword">long</span> totalComplete = <span class="number">0</span>;</div><div class="line">dispatch_source_set_event_handler(source, ^&#123;</div><div class="line">	<span class="keyword">long</span> value = dispatch_source_get_data(source);</div><div class="line">	totalComplete += value;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// created cource is in suspended status</span></div><div class="line"><span class="comment">// needs to be resumed</span></div><div class="line">dispatch_resume(source);</div><div class="line"></div><div class="line"><span class="comment">// sending data to the source</span></div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt;= <span class="number">100</span>; i++) &#123;</div><div class="line">		dispatch_source_merge_data(source, <span class="number">1</span>);</div><div class="line">		usleep(<span class="number">200000</span>);</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>注意不可发送0 或者 复数</p>
<h5 id="dispatch-timer"><a href="#dispatch-timer" class="headerlink" title="dispatch timer"></a>dispatch timer</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> dispatch_source_set_timer( dispatch_source_t source, dispatch_time_t start, uint64_t interval, uint64_t leeway);</div></pre></td></tr></table></figure>
<p>start - start after the start interval<br>interval - execution interval. the handler will be called with after the first execution repeately with the interval. set to DISPATCH_TIME_FOREVER if you want to perform it only once. (use dispatch_after if you want to perform some task after a delay only once)<br>leeway - the time allowed for delay. used a hint to the system<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>);</div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">5</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>);</div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        <span class="comment">// perform some tasks</span></div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// to cancel the timer after 10 seconds</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> q = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>);</div><div class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">10</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</div><div class="line">        dispatch_cancel(timer);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<h5 id="Queue-sepcific-data"><a href="#Queue-sepcific-data" class="headerlink" title="Queue sepcific data"></a>Queue sepcific data</h5><p>Similiar to the Associated Object. Assign a key-value pair to a queue. A release function is required.<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> key;</div><div class="line"><span class="built_in">CFStringRef</span> *value = <span class="built_in">CFSTR</span>(<span class="string">"some string"</span>);</div><div class="line">dispatch_queue_set_specific(queue,  </div><div class="line">                              &amp;key,  </div><div class="line">                              (<span class="keyword">void</span>*)value,  </div><div class="line">                              (dispatch_function_t)<span class="built_in">CFRelease</span>); </div><div class="line">                              </div><div class="line">   <span class="built_in">CFStringRef</span> *str = dispatch_get_specific(&amp;key);</div></pre></td></tr></table></figure></p>
<p>如果找不到key, 会向target queue 查询。</p>
<p>例子<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch_queue_set_specific(q, &amp;key, (__bridge <span class="keyword">void</span>*)q, <span class="literal">NULL</span>);</div></pre></td></tr></table></figure></p>
<p>因为dispatch_get_current_queue 可能会造成死锁，如下，get current queue 检查为当前queue 为queue B, 所以调用 dispatch_sync(queueA, …), 造成死锁（因为最外面还套一个 dispatch_sync(queueA, …)）<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// a 'not' safe sync</span></div><div class="line"><span class="keyword">void</span> dispatch_sync_safe(<span class="built_in">dispatch_queue_t</span> queue, dispatch_block_t block) &#123;</div><div class="line">	<span class="keyword">if</span> (dispatch_get_current_queue() == queue) &#123;</div><div class="line">		block();</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="built_in">dispatch_sync</span>(queue, block);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">dispatch_sync</span>(queueA, ^&#123;</div><div class="line">	<span class="built_in">dispatch_sync</span>(queueB, ^&#123;</div><div class="line">		 dispatch_sync_safe(queueA, ^&#123;</div><div class="line">		 	<span class="comment">// some tasks...</span></div><div class="line">		 &#125;)</div><div class="line">	&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面的dispatch_sync_safe 重入，导致deadlock</p>
<p>解决方法：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> sQueueTagKey;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RNQueueTag(<span class="built_in">dispatch_queue_t</span> q) &#123;</div><div class="line">  <span class="comment">// Make q point to itself by assignment.</span></div><div class="line">  <span class="comment">// This doesn't retain, but it can never dangle.</span></div><div class="line">  dispatch_queue_set_specific(q, &amp;sQueueTagKey, (__bridge <span class="keyword">void</span>*)q, <span class="literal">NULL</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> RNQueueCreateTagged(<span class="keyword">const</span> <span class="keyword">char</span> *label,</div><div class="line">                                     dispatch_queue_attr_t attr) &#123;</div><div class="line">  <span class="built_in">dispatch_queue_t</span> q = dispatch_queue_create(label, attr);</div><div class="line">  RNQueueTag(q);</div><div class="line">  <span class="keyword">return</span> q;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> RNQueueGetCurrentTagged() &#123;</div><div class="line">  <span class="keyword">return</span> (__bridge <span class="built_in">dispatch_queue_t</span>)dispatch_get_specific(&amp;sQueueTagKey);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">BOOL</span> RNQueueCurrentIsTaggedQueue(<span class="built_in">dispatch_queue_t</span> q) &#123;</div><div class="line">  <span class="keyword">return</span> (RNQueueGetCurrentTagged() == q);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">BOOL</span> RNQueueCurrentIsMainQueue() &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="built_in">NSThread</span> isMainThread];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RNQueueSafeDispatchSync(<span class="built_in">dispatch_queue_t</span> q, dispatch_block_t block) &#123;</div><div class="line">  <span class="keyword">if</span> (RNQueueCurrentIsTaggedQueue(q)) &#123;</div><div class="line">    block();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">dispatch_sync</span>(q, block);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面利用Queue sepcific data 会像target queue询问的特性来避免死锁。<br>不过只能应对这种只有两条queue 的情况，而且只能给最外面的queue 加上标签。（所以有啥用啊。。。）</p>
<h4 id="References"><a href="#References" class="headerlink" title="References"></a>References</h4><ol>
<li>iOS 7 Programming: Pushing the limit</li>
<li>Objective-C 高级编程</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2016/01/23/CALayer-hittest-检索顺序/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/23/CALayer-hittest-检索顺序/" itemprop="url">
                  CALayer hittest 遍历顺序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-23T12:36:54+08:00">
                2016-01-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/01/23/CALayer-hittest-检索顺序/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/01/23/CALayer-hittest-检索顺序/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CALayer 的 hittest 可以返回一个点所在点最远的layer。那么这个检查sublayer的顺序是怎么样的呢？<br>为了得到这个顺序，我们先用method swizzling 在 [CALayer hittest:] 里面加上一行打印当前layer 的代码<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CALayer</span>(<span class="title">hitTestTracking</span>)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> hitTestTrackingOnceToken;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;hitTestTrackingOnceToken, ^&#123;</div><div class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</div><div class="line">        SEL oriSelector = <span class="keyword">@selector</span>(hitTest:);</div><div class="line">        SEL swSelector = <span class="keyword">@selector</span>(xl_hitTest:);</div><div class="line">        </div><div class="line">        Method oriMethod = class_getInstanceMethod(<span class="keyword">class</span>, oriSelector);</div><div class="line">        Method swMethod = class_getInstanceMethod(<span class="keyword">class</span>, swSelector);</div><div class="line">        </div><div class="line">        <span class="built_in">BOOL</span> addedMethod = class_addMethod(<span class="keyword">class</span>, oriSelector, method_getImplementation(swMethod), method_getTypeEncoding(swMethod));</div><div class="line">        <span class="keyword">if</span> (addedMethod) &#123;</div><div class="line">            class_replaceMethod(<span class="keyword">class</span>, swSelector, method_getImplementation(oriMethod), method_getTypeEncoding(oriMethod));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            method_exchangeImplementations(oriMethod, swMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">CALayer</span> *)xl_hitTest:(<span class="built_in">CGPoint</span>)p &#123;</div><div class="line">    <span class="built_in">CALayer</span> *hittedLayer = [<span class="keyword">self</span> xl_hitTest:p];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@ hitted: %@"</span>, <span class="built_in">NSStringFromSelector</span>(_cmd), <span class="keyword">self</span>.name, <span class="keyword">self</span>, (hittedLayer == <span class="literal">nil</span> ? <span class="string">@"NO"</span> : <span class="string">@"YES"</span>));</div><div class="line">    <span class="keyword">return</span> hittedLayer;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了方便再加上打印sublayers的方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)printSubLayers &#123;</div><div class="line">    [<span class="keyword">self</span> printSubLayersWithNumberOfIndentation:<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)printSubLayersWithNumberOfIndentation:(<span class="built_in">NSInteger</span>)numberOfIndentation &#123;</div><div class="line">    <span class="built_in">NSInteger</span> n = numberOfIndentation;</div><div class="line">    <span class="keyword">while</span> (n--) &#123;</div><div class="line">        printf(<span class="string">"----"</span>);</div><div class="line">    &#125;</div><div class="line">    printf(<span class="string">"%s %s\n"</span>, <span class="keyword">self</span>.name.UTF8String, <span class="keyword">self</span>.description.UTF8String);</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">CALayer</span> *layer <span class="keyword">in</span> <span class="keyword">self</span>.sublayers) &#123;</div><div class="line">        [layer printSubLayersWithNumberOfIndentation:numberOfIndentation + <span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在view controller 随便创建一个view, 加入一些 layer 并调用 hittest 来进行<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.layerView.layer.name = <span class="string">@"layer 0"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer1 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer1.backgroundColor = [<span class="built_in">UIColor</span> grayColor].CGColor;</div><div class="line">    layer1.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer1.name = <span class="string">@"layer 1"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer2 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer2.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer2.name = <span class="string">@"layer 2"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer3 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer3.frame = <span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">5</span>, <span class="number">5</span>);</div><div class="line">    layer3.name = <span class="string">@"layer 3"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer11 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer11.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer11.name = <span class="string">@"layer 11"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer111 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer111.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer111.name = <span class="string">@"layer 111"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer12 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer12.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer12.name = <span class="string">@"layer 12"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer21 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer21.frame = <span class="keyword">self</span>.layerView.bounds;</div><div class="line">    layer21.name = <span class="string">@"layer 21"</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">CALayer</span> *layer31 = [<span class="built_in">CALayer</span> layer];</div><div class="line">    layer31.frame = <span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">5</span>, <span class="number">5</span>);</div><div class="line">    layer31.name = <span class="string">@"layer 31"</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.layerView.layer addSublayer:layer1];</div><div class="line">    [<span class="keyword">self</span>.layerView.layer addSublayer:layer2];</div><div class="line">    [<span class="keyword">self</span>.layerView.layer addSublayer:layer3];</div><div class="line">    [layer1 addSublayer:layer11];</div><div class="line">    [layer1 addSublayer:layer12];</div><div class="line">    [layer11 addSublayer:layer111];</div><div class="line">    [layer2 addSublayer:layer21];</div><div class="line">    [layer3 addSublayer:layer31];</div><div class="line">    </div><div class="line">    <span class="built_in">CGPoint</span> p = [<span class="keyword">self</span>.view convertPoint:<span class="built_in">CGPointZero</span> fromView:<span class="keyword">self</span>.layerView];</div><div class="line">    [<span class="keyword">self</span>.layerView.layer printSubLayers];</div><div class="line">    <span class="built_in">CALayer</span> *layerHitted = [<span class="keyword">self</span>.layerView.layer hitTest:p];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"layer hitted: %@ %@"</span>, layerHitted.name, layerHitted);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>得到如下输出：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be1e6e0</span>&gt;</div><div class="line">----layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be26ef0</span>&gt;</div><div class="line">--------layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c720</span>&gt;</div><div class="line">------------layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c740</span>&gt;</div><div class="line">--------layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e50</span>&gt;</div><div class="line">----layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c6e0</span>&gt;</div><div class="line">--------layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e70</span>&gt;</div><div class="line">----layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c700</span>&gt;</div><div class="line">--------layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e90</span>&gt;</div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.167</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c740</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.169</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c720</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.170</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e50</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.170</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be26ef0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.170</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e70</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.170</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c6e0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.171</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e90</span>&gt; hitted: <span class="literal">NO</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.171</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be2c700</span>&gt; hitted: <span class="literal">NO</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.172</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] hitTest: layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be1e6e0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">50.172</span> learnLayer[<span class="number">1966</span>:<span class="number">258255</span>] layer hitted: layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fc62be10e70</span>&gt;</div></pre></td></tr></table></figure></p>
<p>从上面我们可以看到，hittest 是用的DFS来遍历图层树，而且不存在短路设置(layer3, layer 31)(其实有短路的，当maskToBounds ＝ YES 的时候就可以有短路了，会在接下来的部分里说明)，所有的layer都会被检查一遍，但是最后返回的结果是在遍历中满足条件的最后一个layer (layer 21)。</p>
<p>接着试着将layer31 的位置改一下使得测试点处于layer31 里面：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">layer31.frame = <span class="built_in">CGRectMake</span>(<span class="number">-100</span>, <span class="number">-100</span>, <span class="number">5</span>, <span class="number">5</span>);</div></pre></td></tr></table></figure></p>
<p>输出变成了：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e9b5b0</span>&gt;</div><div class="line">----layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e90420</span>&gt;</div><div class="line">--------layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b730</span>&gt;</div><div class="line">------------layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b750</span>&gt;</div><div class="line">--------layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8df90</span>&gt;</div><div class="line">----layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e06460</span>&gt;</div><div class="line">--------layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8dfb0</span>&gt;</div><div class="line">----layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b680</span>&gt;</div><div class="line">--------layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e90c50</span>&gt;</div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.951</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b750</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.952</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b730</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8df90</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e90420</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8dfb0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e06460</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e90c50</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e8b680</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.953</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] hitTest: layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e9b5b0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">39</span>:<span class="number">13.954</span> learnLayer[<span class="number">2076</span>:<span class="number">266220</span>] layer hitted: layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb920e90c50</span>&gt;</div></pre></td></tr></table></figure></p>
<p>最终的结果变成了layer31，从这里我们就可以知道为什么不存在简单的短路设置（如果当前图层的位置的大小不满足条件就不遍历其子图层）了，因为子图层的位置与父图层并不存在直接关系，一个不在父图层中的点仍可能在其子图层中。</p>
<p>让我们再来把layer3 的maskToBounds 设为 YES:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">layer3.masksToBounds = <span class="literal">YES</span>;</div></pre></td></tr></table></figure></p>
<p>再跑一遍，输出又变了：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1488f80</span>&gt;</div><div class="line">----layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1403cd0</span>&gt;</div><div class="line">--------layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1489a20</span>&gt;</div><div class="line">------------layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b880</span>&gt;</div><div class="line">--------layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b8a0</span>&gt;</div><div class="line">----layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f14879e0</span>&gt;</div><div class="line">--------layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b8c0</span>&gt;</div><div class="line">----layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1489a00</span>&gt;</div><div class="line">--------layer <span class="number">31</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1489de0</span>&gt;</div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.756</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">111</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b880</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.757</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">11</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1489a20</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.757</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">12</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b8a0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.757</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">1</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1403cd0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.757</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b8c0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.758</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">2</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f14879e0</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.758</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">3</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1489a00</span>&gt; hitted: <span class="literal">NO</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.772</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] hitTest: layer <span class="number">0</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f1488f80</span>&gt; hitted: <span class="literal">YES</span></div><div class="line"><span class="number">2016</span><span class="number">-01</span><span class="number">-24</span> <span class="number">00</span>:<span class="number">47</span>:<span class="number">55.772</span> learnLayer[<span class="number">2097</span>:<span class="number">272073</span>] layer hitted: layer <span class="number">21</span> &lt;<span class="built_in">CALayer</span>: <span class="number">0x7fb8f148b8c0</span>&gt;</div></pre></td></tr></table></figure></p>
<p>我们可以看到当开启maskToBounds 之后，便开始有短路了，layer31 不再出现在遍历树里面。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/12/06/avfoundation-video-capture1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/06/avfoundation-video-capture1/" itemprop="url">
                  用Avfoundation 录像(续)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-06T12:29:05+08:00">
                2015-12-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/06/avfoundation-video-capture1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/06/avfoundation-video-capture1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>除了直接用AVCaptureMovieFileOutput，还可以把AVCaptureVideoDataOutput，AVCaptureAudioDataOutput 当作output。这两个class的delegate AVCaptureVideoDataOutputSampleBufferDelegate, AVCaptureAudioDataOutputSampleBufferDelegate 有一个- (void)captureOutput:(AVCaptureOutput )captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection )connection 的method, 开始录像之后你可以从这个method 里面拿到每一个录下的frame，然后可以用AVAssetWriter来写入local的文件。</p>
<ol>
<li><p>加output</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">_videoDataOutput = [<span class="built_in">AVCaptureVideoDataOutput</span> new];</div><div class="line">_audioDataOutput = [<span class="built_in">AVCaptureAudioDataOutput</span> new];</div><div class="line"><span class="keyword">if</span> ([_captureSession canAddOutput:_videoDataOutput]) &#123;</div><div class="line">    DLog(<span class="string">@"added video out"</span>);</div><div class="line">    [_captureSession addOutput:_videoDataOutput];</div><div class="line">&#125;</div><div class="line">_videoConnection = [_videoDataOutput connectionWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</div><div class="line">_videoConnection.videoOrientation = <span class="built_in">AVCaptureVideoOrientationPortrait</span>;</div><div class="line"></div><div class="line">[_videoDataOutput setSampleBufferDelegate:<span class="keyword">self</span> queue:_videoDataOutputQueue];</div><div class="line"></div><div class="line"><span class="keyword">if</span> ([_captureSession canAddOutput:_audioDataOutput]) &#123;</div><div class="line">    DLog(<span class="string">@"added audio out"</span>);</div><div class="line">    [_captureSession addOutput:_audioDataOutput];</div><div class="line">&#125;</div><div class="line">_audioConnection = [_audioDataOutput connectionWithMediaType:<span class="built_in">AVMediaTypeAudio</span>];</div><div class="line">[_audioDataOutput setSampleBufferDelegate:<span class="keyword">self</span> queue:_audioDataOutputQueue];</div></pre></td></tr></table></figure>
</li>
<li><p>准备AVAssetWriter, 需要两个writerInput 分别写入video 和audio</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">_assetWriter = [<span class="built_in">AVAssetWriter</span> assetWriterWithURL:[<span class="keyword">self</span> outputURL] fileType:<span class="built_in">AVFileTypeMPEG4</span> error:<span class="literal">nil</span>];</div><div class="line">_videoAssetWriterInput = [[<span class="built_in">AVAssetWriterInput</span> alloc] initWithMediaType:<span class="built_in">AVMediaTypeVideo</span></div><div class="line">                                                                outputSettings:[_videoDataOutput recommendedVideoSettingsForAssetWriterWithOutputFileType:<span class="built_in">AVFileTypeMPEG4</span>]];</div><div class="line">_videoAssetWriterInput.expectsMediaDataInRealTime = <span class="literal">YES</span>;</div><div class="line">_audioAssetWriterInput = [[<span class="built_in">AVAssetWriterInput</span> alloc] initWithMediaType:<span class="built_in">AVMediaTypeAudio</span></div><div class="line">                                                                outputSettings:[_audioDataOutput recommendedAudioSettingsForAssetWriterWithOutputFileType:<span class="built_in">AVFileTypeMPEG4</span>]];</div><div class="line">_audioAssetWriterInput.expectsMediaDataInRealTime = <span class="literal">YES</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ([_assetWriter canAddInput:_videoAssetWriterInput]) &#123;</div><div class="line">    DLog(<span class="string">@"added video out writer"</span>);</div><div class="line">    [_assetWriter addInput:_videoAssetWriterInput];</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> ([_assetWriter canAddInput:_audioAssetWriterInput]) &#123;</div><div class="line">    DLog(<span class="string">@"added audio out writer"</span>);</div><div class="line">    [_assetWriter addInput:_audioAssetWriterInput];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>填写 - (void)captureOutput:(AVCaptureOutput )captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection )connection</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput didOutputSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)sampleBuffer fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CFRetain</span>(sampleBuffer);</div><div class="line">    <span class="built_in">CMFormatDescriptionRef</span> formatDesc = <span class="built_in">CMSampleBufferGetFormatDescription</span>(sampleBuffer);</div><div class="line">    <span class="built_in">CMMediaType</span> mediaType = <span class="built_in">CMFormatDescriptionGetMediaType</span>(formatDesc);</div><div class="line">    <span class="built_in">CMTime</span> currentSampleTime = <span class="built_in">CMSampleBufferGetPresentationTimeStamp</span>(sampleBuffer);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mediaType == kCMMediaType_Video) &#123;</div><div class="line">        <span class="keyword">if</span>(_firstSample) &#123;</div><div class="line">            <span class="keyword">if</span> ([_assetWriter startWriting]) &#123;</div><div class="line">                [_assetWriter startSessionAtSourceTime:currentSampleTime];</div><div class="line">                _firstSample = <span class="literal">NO</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                DLog(<span class="string">@"Error when starting avseet writer, %ld %@, %@"</span>, (<span class="keyword">long</span>)_assetWriter.status, [_assetWriter.error localizedDescription], [_assetWriter.error userInfo]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (_videoAssetWriterInput.readyForMoreMediaData) &#123;</div><div class="line">            [_videoAssetWriterInput appendSampleBuffer:bufferToWrite];</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mediaType == kCMMediaType_Audio &amp;&amp; !_firstSample) &#123;</div><div class="line">        <span class="keyword">if</span> (_audioAssetWriterInput.readyForMoreMediaData) &#123;</div><div class="line">            [_audioAssetWriterInput appendSampleBuffer:bufferToWrite];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CFRelease</span>(sampleBuffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在didOutputSampleBuffer里面拿到sample buffer 之后还可以对其进行各种处理－－将其转化为CIImage ，然后就可以apply 各种filter。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFRetain</span>(pixelBuffer);</div><div class="line">CVPixelBufferLockBaseAddress(pixelBuffer, <span class="number">0</span> );</div><div class="line"></div><div class="line"><span class="built_in">CIImage</span> *img = [<span class="built_in">CIImage</span> imageWithCVPixelBuffer:pixelBuffer];</div><div class="line"><span class="built_in">CIFilter</span> *filter = [<span class="built_in">CIFilter</span> filterWithName:&lt;filterName&gt;]; <span class="comment">//具体 filter可以参考[Core Image Filter Reference](https://developer.apple.com/library/prerelease/mac/documentation/GraphicsImaging/Reference/CoreImageFilterReference/index.html)</span></div><div class="line"></div><div class="line">... apply filters</div><div class="line"></div><div class="line"><span class="built_in">CIImage</span> *outputImage = [filter outputImage];</div><div class="line">[_ciContext render:outputImage toCVPixelBuffer:pixelBuffer]; <span class="comment">//把处理好的ciimage 再写回buffer</span></div><div class="line"></div><div class="line">CVPixelBufferUnlockBaseAddress(pixelBuffer, <span class="number">0</span>);</div><div class="line"><span class="built_in">CFRelease</span>(pixelBuffer);</div></pre></td></tr></table></figure>
</li>
<li><p>那么live preview 呢，其实如果没有别的要求的话可以直接用之前用的AVCaptureVideoPreviewLayer，但是如果要在live preview 里面显示filter 的效果的话。那么就要将frame 画到一个GLKView 上面，然后把这个view 展示给user.</p>
<p>create GLKView。这里要用 EAGLContext来create CIContext 这样具体draw的时候就会用GPU 来draw 了，否则将使用CPU 来画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">_eaglContext = [[EAGLContext alloc] initWithAPI:kEAGLRenderingAPIOpenGLES2];</div><div class="line">_ciContext = [<span class="built_in">CIContext</span> contextWithEAGLContext:_eaglContext options:@&#123;kCIContextWorkingColorSpace : [<span class="built_in">NSNull</span> null]&#125; ];</div><div class="line">    </div><div class="line">GLKView *glkView = [[GLKView alloc] initWithFrame:&lt;frame&gt; context:_eaglContext];</div><div class="line">[glkView bindDrawable];</div><div class="line">_livePreviewView = glkView;</div></pre></td></tr></table></figure>
<p>画frame</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">CFRetain</span>(pixelBuffer);</div><div class="line">CVPixelBufferLockBaseAddress(pixelBuffer, <span class="number">0</span> );</div><div class="line"></div><div class="line"><span class="built_in">CIImage</span> *img = [<span class="built_in">CIImage</span> imageWithCVPixelBuffer:pixelBuffer];</div><div class="line"></div><div class="line">[_ciContext drawImage:outputImage inRect:previewRect fromRect:cropRect];</div><div class="line">[((GLKView *)_livePreviewView) display];</div><div class="line"></div><div class="line">CVPixelBufferUnlockBaseAddress(pixelBuffer, <span class="number">0</span>);</div><div class="line"><span class="built_in">CFRelease</span>(pixelBuffer);</div></pre></td></tr></table></figure>
</li>
<li><p>最后保存到Library</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[_captureSession stopRunning];</div><div class="line">[_videoAssetWriterInput markAsFinished];</div><div class="line">[_audioAssetWriterInput markAsFinished];</div><div class="line"></div><div class="line">[_assetWriter finishWritingWithCompletionHandler:^&#123;</div><div class="line">    ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];</div><div class="line">    <span class="keyword">if</span> ([library videoAtPathIsCompatibleWithSavedPhotosAlbum:videoURL]) &#123;</div><div class="line">        [library writeVideoAtPathToSavedPhotosAlbum:videoURL completionBlock:^(<span class="built_in">NSURL</span> *assetURL, <span class="built_in">NSError</span> *error)&#123;</div><div class="line">            <span class="keyword">if</span> (error) &#123;</div><div class="line">                ALog(<span class="string">@"Error when saving captured video to library, error = %@, url = %@"</span>, error, assetURL);</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/11/15/autolayout-content-size/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/15/autolayout-content-size/" itemprop="url">
                  AutoLayout Content Size
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-15T12:27:24+08:00">
                2015-11-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/11/15/autolayout-content-size/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/15/autolayout-content-size/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要记下Intrinsic Size, Content Hugging/Compression Resistance Priority 是干什么的。</p>
<h4 id="Intrinsic-Size"><a href="#Intrinsic-Size" class="headerlink" title="Intrinsic Size"></a>Intrinsic Size</h4><p>一个view 原本应该有的size，比如一个text label 就是text label 显示完整的text 需要的size, image view 就是这个image 的size。有了Intrinsic Size 之后，再specify 了关于location 的constriant, autolayout 就可以帮你摆放这个view 了。</p>
<h4 id="Content-Compression-Resitance-Priority"><a href="#Content-Compression-Resitance-Priority" class="headerlink" title="Content Compression Resitance Priority"></a>Content Compression Resitance Priority</h4><p>一个View 反缩小的Priority。</p>
<h4 id="Content-Hugging-Priority"><a href="#Content-Hugging-Priority" class="headerlink" title="Content Hugging Priority"></a>Content Hugging Priority</h4><p>一个View 反放大的Priority。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/11/13/learning-cocoa-with-objc-reading-notes/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/13/learning-cocoa-with-objc-reading-notes/" itemprop="url">
                  Learning Cocoa with Objc reading notes
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-13T23:48:59+08:00">
                2015-11-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/11/13/learning-cocoa-with-objc-reading-notes/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/11/13/learning-cocoa-with-objc-reading-notes/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Learning Cocoa with Objective-C 这本书我差不多读了一半，感觉这本书比较像一本参考书，要做某个功能可以参考下了解一下基本的东西。跳过了一些章节，把自己之前不知道的一些东西记一下。</p>
<h4 id="NSData"><a href="#NSData" class="headerlink" title="NSData"></a>NSData</h4><p>NSData contains bytes with no assumptions of the type of data.<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//load file into NSData</span></div><div class="line"><span class="built_in">NSData</span> *loadedData = [<span class="built_in">NSData</span> dataWithContentsOfFile:&lt;filePath&gt;];</div></pre></td></tr></table></figure></p>
<p>NSData itself is useless<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *loadedString = [[<span class="built_in">NSString</span> alloc] initWithData:loadedData</div><div class="line">                                        encoding:<span class="built_in">NSUTF8Encoding</span>];</div><div class="line"><span class="comment">//encoding:NSUTF8Encoding tells NSString how to interrprate the bytes in NSData</span></div></pre></td></tr></table></figure></p>
<h4 id="NSCoding"><a href="#NSCoding" class="headerlink" title="NSCoding"></a>NSCoding</h4><p>Serialization and Deserialization in Cocoa<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// confirming to NSCoding</span></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSKeyedArchiver</span> *)aCoder&#123;</div><div class="line">    [aCoder encodeObject:&lt;obj&gt; forKey:&lt;key&gt;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)initWithCoder:(<span class="built_in">NSKeyedArchiver</span> *)aCoder&#123;</div><div class="line">    ...</div><div class="line">    _obj = [aDecoder decodeObjectForKey:&lt;key&gt;]</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Working with NSData<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// store</span></div><div class="line"><span class="built_in">NSData</span> *storedData = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:myObject];</div><div class="line">[storedData writeToFile:&lt;filePath&gt; atomically:<span class="literal">YES</span>];</div><div class="line"></div><div class="line"><span class="comment">// retrive</span></div><div class="line">SomeObj *obj = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:storedData];</div></pre></td></tr></table></figure></p>
<h4 id="Using-NSBundle-to-find-resources"><a href="#Using-NSBundle-to-find-resources" class="headerlink" title="Using NSBundle to find resources"></a>Using NSBundle to find resources</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"SomeImage"</span> ofType:<span class="string">@"png"</span>];</div></pre></td></tr></table></figure>
<h4 id="MultiTasking-on-iOS"><a href="#MultiTasking-on-iOS" class="headerlink" title="MultiTasking on iOS"></a>MultiTasking on iOS</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applicationDidEnterBacktround:(<span class="built_in">UIApplication</span> *)application</div></pre></td></tr></table></figure>
<p>Any task like saving to disk needs to be performed at this moment. Background app can be killed at anytime and no code can be executed at while being suspended.</p>
<h4 id="Request-to-run-in-background"><a href="#Request-to-run-in-background" class="headerlink" title="Request to run in background"></a>Request to run in background</h4><p>App can request to run in background for no more 10 mins<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)applicationDidEnterBackground:(<span class="built_in">UIApplication</span> *)application</div><div class="line">&#123;</div><div class="line">    <span class="comment">// beginBackgroundTaskWithExpirationHandler returns a unqie ident for the task</span></div><div class="line">    bgTask = [application beginBackgroundTaskWithExpirationHandler:^&#123;</div><div class="line">        [application endBackgroundTask:bgTask];</div><div class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPTACH_QUEU_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">        ....bgTasks... </div><div class="line">        [application endBackgroundTask:bgTask];</div><div class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Tasks that can run for a longer time</p>
<ol>
<li>playing audio</li>
<li>tracking location</li>
<li>VoIP</li>
</ol>
<h4 id="Nib"><a href="#Nib" class="headerlink" title="Nib"></a>Nib</h4><p>Nib – “freeze-drying” objects and storing them in a serialized form inside the file.<br>When displaying, loads the nib file, “rehydrates” the stored bojects, and presents them to the user.</p>
<h4 id="How-Nib-Files-are-Loaded"><a href="#How-Nib-Files-are-Loaded" class="headerlink" title="How Nib Files are Loaded"></a>How Nib Files are Loaded</h4><ol>
<li>re-create every objects in the nib</li>
<li>connect evey outlet</li>
<li>every single object loaded receives awakeFromNib: message</li>
</ol>
<h4 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">return</span> type&gt;(^ &lt;variable name&gt;) (&lt;params&gt;)</div></pre></td></tr></table></figure>
<p>Blocks exist in stack when created, thus then assign to like instance variable, the block needs to be copied to the heap.<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_var = [bomeBlock <span class="keyword">copy</span>];</div></pre></td></tr></table></figure></p>
<p>Blocks keep strong ref to variables captured.<br>To modify captured variables, add __block modifier.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__block <span class="keyword">int</span> i = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<h4 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h4><ol>
<li>accessing key that doesn’t exist causes exception</li>
<li>is able to access even private vriables<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// determine the varibale to set/get at run time</span></div><div class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> * key <span class="keyword">in</span> dict) &#123;</div><div class="line">    <span class="built_in">NSObject</span> *value = [dict objectForKey:key];</div><div class="line">    [aProduct setValue:value forKey:key];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h4><ol>
<li>synthesized property auto notify changes when setter is called</li>
<li>overried setter -&gt; needs to fire notifiction manually<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name &#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"name"</span>];</div><div class="line">    _name = name;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"name"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="NSNotification"><a href="#NSNotification" class="headerlink" title="NSNotification"></a>NSNotification</h4><p>broadcast notifications, typically one singleton notification center. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/10/27/avfoundation-video-capture/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/27/avfoundation-video-capture/" itemprop="url">
                  用Avfoundation 录像
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-27T23:40:23+08:00">
                2015-10-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/10/27/avfoundation-video-capture/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/27/avfoundation-video-capture/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参考了<a href="https://www.objc.io/issues/23-video/capturing-video/" target="_blank" rel="external">Capturing Video on iOS</a>, <a href="https://dannygtech.wordpress.com/2014/03/04/custom-camera-on-ios-avcapturesession-avcapturevideopreviewlayer-tutorial/" target="_blank" rel="external">CUSTOM CAMERA ON IOS – AVCAPTURESESSION, AVCAPTUREVIDEOPREVIEWLAYER TUTORIAL</a>。（吐槽一下<a href="https://www.objc.io/issues/23-video/capturing-video/" target="_blank" rel="external">Capturing Video on iOS</a>… sample code 搞那么复杂干嘛。。）</p>
<h4 id="先开一个新的AVCaptureSession"><a href="#先开一个新的AVCaptureSession" class="headerlink" title="先开一个新的AVCaptureSession"></a>先开一个新的AVCaptureSession</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">AVCaptureSession</span> *captureSession = [<span class="built_in">AVCaptureSession</span> new];</div><div class="line">[captureSession setSessionPreset:<span class="built_in">AVCaptureSessionPresetHigh</span>];<span class="comment">// the video quiality</span></div></pre></td></tr></table></figure>
<h4 id="然后加入audio-和video-inputs"><a href="#然后加入audio-和video-inputs" class="headerlink" title="然后加入audio 和video inputs"></a>然后加入audio 和video inputs</h4><p>audio<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">AVAudioSession</span> *audioSession = [<span class="built_in">AVAudioSession</span> sharedInstance];</div><div class="line">[audioSession setCategory:<span class="built_in">AVAudioSessionCategoryPlayAndRecord</span> error:<span class="literal">nil</span>];<span class="comment">//allow recording and replaying at the same time</span></div><div class="line">[audioSession setActive:<span class="literal">YES</span> error:<span class="literal">nil</span>];</div><div class="line"><span class="built_in">AVCaptureDeviceInput</span> *micDeviceInput = [[<span class="built_in">AVCaptureDeviceInput</span> alloc] initWithDevice:[<span class="built_in">AVCaptureDevice</span> defaultDeviceWithMediaType:<span class="built_in">AVMediaTypeAudio</span>] error:&amp;error];</div><div class="line"><span class="keyword">if</span> ([captureSession canAddInput:micDeviceInput]) &#123;</div><div class="line">    [captureSession addInput:micDeviceInput];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>video<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">AVCaptureDevice *cameraDevice = nil;</div><div class="line">NSArray *devices = [AVCaptureDevice devicesWithMediaType:AVMediaTypeVideo];</div><div class="line"></div><div class="line">// make it the front camera</div><div class="line">for (AVCaptureDevice *device in devices) &#123;</div><div class="line">    if ([device position] == AVCaptureDevicePositionFront) &#123;</div><div class="line">        cameraDevice = device;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">AVCaptureDeviceInput *cameraDeviceInput = [[AVCaptureDeviceInput alloc] initWithDevice:cameraDevice error:&amp;error];</div><div class="line">if ([captureSession canAddInput:cameraDeviceInput]) &#123;</div><div class="line">    [captureSession addInput:cameraDeviceInput];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="然后把output也连上"><a href="#然后把output也连上" class="headerlink" title="然后把output也连上"></a>然后把output也连上</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">AVCaptureMovieFileOutput</span> *movieFileOutput = [<span class="built_in">AVCaptureMovieFileOutput</span> new];</div><div class="line"><span class="keyword">if</span>([captureSession canAddOutput:movieFileOutput])&#123;</div><div class="line">    [captureSession addOutput:movieFileOutput];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="最后再加个显示live-preview-的layer"><a href="#最后再加个显示live-preview-的layer" class="headerlink" title="最后再加个显示live preview 的layer"></a>最后再加个显示live preview 的layer</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">AVCaptureVideoPreviewLayer</span> *previewLayer = [[<span class="built_in">AVCaptureVideoPreviewLayer</span> alloc] initWithSession:captureSession];</div><div class="line"><span class="built_in">UIView</span> *camView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(...)];</div><div class="line">previewLayer.frame = camView.bounds;</div><div class="line">previewLayer.videoGravity = <span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;</div><div class="line">[camView.layer addSublayer:previewLayer];</div><div class="line">[<span class="keyword">self</span>.view addSubview:camView];</div></pre></td></tr></table></figure>
<h4 id="开始录像"><a href="#开始录像" class="headerlink" title="开始录像"></a>开始录像</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *outputURL = [<span class="built_in">NSURL</span> fileURLWithPath:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@tmp.mov"</span>, <span class="built_in">NSTemporaryDirectory</span>()]];</div><div class="line">[captureSession startRunning];</div><div class="line">[movieFileOutput startRecordingToOutputFileURL:outputURL recordingDelegate:<span class="keyword">self</span>];</div></pre></td></tr></table></figure>
<h4 id="结束-amp-保存"><a href="#结束-amp-保存" class="headerlink" title="结束&amp;保存"></a>结束&amp;保存</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[_captureSession stopRunning];</div><div class="line">[_movieFileOutput stopRecording];</div><div class="line"><span class="built_in">UISaveVideoAtPathToSavedPhotosAlbum</span>(_movieFileOutput.outputFileURL.path, <span class="literal">nil</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div></pre></td></tr></table></figure>
<p>完🐶</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/10/19/core-data-part-1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/19/core-data-part-1/" itemprop="url">
                  Core Data (Part 1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-19T23:11:57+08:00">
                2015-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/10/19/core-data-part-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/19/core-data-part-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现在在读Marcus S. Zarra的<a href="https://pragprog.com/book/mzcd2/core-data" target="_blank" rel="external">Core Data</a>。自己也写了一些code来尝试core data。所以在这里总结一下。不对的地方请指正:)</p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><p>Core Data 对几个部分：NSManagedObjectModel, NSPersistentStoreCoordinator, NSPersistentStore, NSManagedObjectContext, NSManagedObject</p>
<h4 id="NSManagedObjectModel"><a href="#NSManagedObjectModel" class="headerlink" title="NSManagedObjectModel"></a>NSManagedObjectModel</h4><p>NSManagedObjectModel 就是你在xcode里面创建的.xcdatamodel 编译过后得到的.mom 的binary file。 它是我们创建的data model。<br>加载NSManagedObjectModel就是用这个.mom file 来 init 一个NSManagedObjectModel:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *modelURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"ModelName"</span> withExtension:<span class="string">@"momd"</span>];</div><div class="line"></div><div class="line">ZAssert(modelURL, <span class="string">@"Failed to find model URL"</span>);</div><div class="line"></div><div class="line"><span class="built_in">NSManagedObjectModel</span> *mom = <span class="literal">nil</span>;</div><div class="line">mom = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</div><div class="line"></div><div class="line">ZAssert(mom, <span class="string">@"Failed to initialize model"</span>);</div></pre></td></tr></table></figure></p>
<p>顺便安利一下ZAssert，详见<a href="http://www.cimgf.com/2010/05/02/my-current-prefix-pch-file/" target="_blank" rel="external">MY CURRENT PREFIX.PCH FILE by Marcus Zarra </a></p>
<h4 id="NSPersistentStoreCoordinator"><a href="#NSPersistentStoreCoordinator" class="headerlink" title="NSPersistentStoreCoordinator"></a>NSPersistentStoreCoordinator</h4><p>NSPersistentStoreCoordinator 是Core Data的核心，负责loading, caching data 还有持久化。而NSPersistentStore 就是持久化的目的地，比如本地的SQlite Database。因为加载NSPersistentStore的时间可能很长（比如从iCould)，所以应当异步执行。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSPersistentStoreCoordinator</span> *psc = <span class="literal">nil</span>;</div><div class="line">psc = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:mom];</div><div class="line"></div><div class="line"><span class="built_in">dispatch_queue_t</span> queue = <span class="literal">NULL</span>;</div><div class="line">queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">    <span class="built_in">NSFileManager</span> *fm = [<span class="built_in">NSFileManager</span> defaultManager];</div><div class="line">    <span class="built_in">NSArray</span> *dictArr = [fm URLsForDirectory:<span class="built_in">NSDocumentationDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">NSURL</span> *storeURL = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    storeURL = [dictArr lastObject];</div><div class="line">    <span class="keyword">if</span> (![fm fileExistsAtPath:[storeURL absoluteString]]) &#123;</div><div class="line">        [fm createDirectoryAtURL:storeURL withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:&amp;error];</div><div class="line">        <span class="keyword">if</span> (error) &#123;</div><div class="line">            ALog(<span class="string">@"Error creating store dictionary %@\n%@"</span>, [error localizedDescription], [error userInfo]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    storeURL = [storeURL URLByAppendingPathComponent:<span class="string">@"TableForDummies.sqlite"</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">NSPersistentStore</span> *store = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    store = [psc addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:<span class="literal">nil</span> error:&amp;error];</div><div class="line">    </div><div class="line">    ZAssert(store, <span class="string">@"Error adding persistent store to coordinator %@\n%@"</span>, [error localizedDescription], [error userInfo]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h4 id="NSManagedObjectContext"><a href="#NSManagedObjectContext" class="headerlink" title="NSManagedObjectContext"></a>NSManagedObjectContext</h4><p>上面几个在init 之后基本都不会再碰了，而NSManagedObjectContext将会被用来保存和读取数据。<br>NSManagedObjectContext 只需要NSPersistentStore 就可以init 了，为了确保程序其他地方可以及时调用到NSManagedContext，NSManagedContext应该在NSPersistentStore init 之后init<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSManagedObjectContext</span> *moc = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSManagedObjectContextConcurrencyType</span> ccType = <span class="built_in">NSMainQueueConcurrencyType</span>;</div><div class="line">moc = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:ccType];</div><div class="line">[moc setPersistentStoreCoordinator:psc];</div></pre></td></tr></table></figure></p>
<p>同时由于NSManagedContext 不是线程安全的，这里用NSMainQueueConcurrencyType，之后对于NSManagedContext 的调用都应该在主线程里。</p>
<h4 id="Fetching-amp-Inserting"><a href="#Fetching-amp-Inserting" class="headerlink" title="Fetching &amp; Inserting"></a>Fetching &amp; Inserting</h4><h5 id="Fetch"><a href="#Fetch" class="headerlink" title="Fetch"></a>Fetch</h5><p>Fetch 的时候要用NSFetchRequest，会得到一条NSManagedObject 的array<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSFetchRequest</span> *request = [[<span class="built_in">NSFetchRequest</span> alloc] init];</div><div class="line">[request setEntity:[<span class="built_in">NSEntityDescription</span> entityForName:<span class="string">@"EntityName"</span> inManagedObjectContext:managedObjectContext]];</div><div class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line"><span class="built_in">NSArray</span> *results = [moc executeFetchRequest:request error:&amp;error];</div></pre></td></tr></table></figure></p>
<p>为fetchRequest 加上filter 和 sorter (否则取回来的东西顺序是随机的)<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// filter</span></div><div class="line"><span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"salary &gt; %i"</span>, basicSalary];</div><div class="line">[request setPredicate:predicate];</div><div class="line"></div><div class="line"><span class="comment">// sorter</span></div><div class="line"><span class="built_in">NSMutableArrary</span> *sortArray = [<span class="built_in">NSMutableArray</span> array] <span class="comment">// 可能有多个sorter</span></div><div class="line">[sortArray addObject:[[<span class="built_in">NSSortDescriptor</span> alloc] initWithKey:<span class="string">@"name"</span> ascending:<span class="literal">YES</span>]];</div><div class="line">[request setSortDescriptor:sortArray];</div></pre></td></tr></table></figure></p>
<p>NSManagedObject 拿到之后就可以用KVC的方法来set/get 里面的值（包括relationship, one-to-many的会得到一个装了相应mangedObject的NSSet）<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[managedObject setValue:value forKey:<span class="string">@"key"</span>];</div><div class="line">[managedObject valueForKey:<span class="string">@"key"</span>];</div><div class="line">[managedObject valueForKey:<span class="string">@"someOneToManyRelationship"</span>]; <span class="comment">// return NSSet filled with cooresponding NSMangedObject on the other side of the relationship</span></div><div class="line"><span class="comment">// 如果需要改变（添加／删除）这个这个Set里面的一些Object</span></div><div class="line">[managedObject mutableSetValueForKey:<span class="string">@"someOneToManyRelationship"</span>]; <span class="comment">// return a mutableSet allowing to add/delete object in the relationship</span></div></pre></td></tr></table></figure></p>
<h5 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h5><p>Insert 则是如下创建一个NSManagedObject 然后set 相应的值就好了<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSManagedObject</span> *obj = [<span class="built_in">NSEntityDescription</span></div><div class="line">                            insertNewObjectForEntityForName: <span class="string">@"ObjName"</span></div><div class="line">                            inManagedObjectContext:context];</div></pre></td></tr></table></figure></p>
<h5 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h5><p>最后Save 所有的changes, 就将数据持久化了<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[context save:&amp;error];</div><div class="line"><span class="keyword">if</span> (error) &#123;</div><div class="line">    ALog(...)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="更简单的用法"><a href="#更简单的用法" class="headerlink" title="更简单的用法"></a>更简单的用法</h4><h5 id="subclass-NSMangedObject"><a href="#subclass-NSMangedObject" class="headerlink" title="subclass NSMangedObject"></a>subclass NSMangedObject</h5><p>用KVC来设置NSManagedObject 显然需要一大段code。而更简单的方法就是直接subclass NSManagedObject, 例如<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyMO</span>: <span class="title">NSManagedObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>) <span class="built_in">NSSet</span> *someOneToManyRelationship; <span class="comment">// relationship也一样</span></div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>别忘了要设成dynamic, 因为这些properity 都是在运行时create 的<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@dynamic</span> name;</div><div class="line"><span class="keyword">@dynamic</span> someOneToManyRelationship;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>然后就可以像直接取用了<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MyMO obj = [...]</div><div class="line">obj.name = <span class="string">"xxx"</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>超方便是不是👍</p>
<h5 id="stored-fetch-request"><a href="#stored-fetch-request" class="headerlink" title="stored fetch request"></a>stored fetch request</h5><p>而fetch request 也是可以存起来的，如下图添加一个fetch request，可以设置fetch的条件<br><img src="/images/core-data-part-1-stored-fetch-request-pic.png" alt=""><br>用的时候..<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSFetchRequest</span> *request = [[[moc persistentStoreCoordinator] managedObjectModel] fetchRequestTemplateForName:<span class="string">@"allDummiesNamedZert"</span>];</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/10/14/How_to_extend_uiview/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/14/How_to_extend_uiview/" itemprop="url">
                  如何extend UIView
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-14T23:06:45+08:00">
                2015-10-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/10/14/How_to_extend_uiview/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/14/How_to_extend_uiview/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要是自己搞了好久才搞对，所以在这里记一下。。。<br>extend 出来的class里面要自己load 一下相应的nib</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CutsomeUIView</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [[<span class="built_in">NSBundle</span> mainBundle] loadNibNamed:<span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class) owner:<span class="keyword">self</span> options:<span class="literal">nil</span>][<span class="number">0</span>];</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [[<span class="built_in">NSBundle</span> mainBundle] loadNibNamed:<span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class) owner:<span class="keyword">self</span> options:<span class="literal">nil</span>][<span class="number">0</span>];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.frame = frame;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>然后xib 里面把class 改成 CustomeUIView。注意是改View的class, 不是File’s Owner… 我之前搞成File’s Owner，然后又把所有的outlet都拉到File’s Owner里面，找了半个小时才找到哪里错了。。。</p>
<p>这样就完成啦～🐶</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://lxian2.space/2015/10/10/Optional/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lxian2">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="lxian's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="lxian's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/10/Optional/" itemprop="url">
                  Swift Optional
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-10-10T23:00:08+08:00">
                2015-10-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/10/10/Optional/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/10/Optional/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本🐶正在学习Swift.被Optional 各种？和！搞得有点晕。参考了<a href="http://www.touch-code-magazine.com/swift-optionals-use-let/" target="_blank" rel="external">Ref1: Swift Optionals: When to use if let, when ? and !, when as? and as</a>, <a href="http://stackoverflow.com/questions/24003642/what-is-an-optional-value-in-swift" target="_blank" rel="external">Ref2: What is an optional value in Swift?</a>之后总结一下Optional是怎么回事，要怎么用。<br>本文的例子都来自于<a href="http://www.touch-code-magazine.com/swift-optionals-use-let/" target="_blank" rel="external">Ref1</a>。</p>
<h4 id="为什么有-Optional"><a href="#为什么有-Optional" class="headerlink" title="为什么有 Optional"></a>为什么有 Optional</h4><p>在obj-c 里面我们可以用nil 来表示空值，比如<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span> arr = <span class="literal">nil</span>;<span class="comment">//这样我们就都知道arr 没有被赋值</span></div></pre></td></tr></table></figure></p>
<p>但是Swift里面我们并不能将nil直接assign给变量，因为Swift 是type safe的。</p>
<p>Swift also introduces optional types, which handle the absence of a value. Optionals say either “there is a value, and it equals x” or “there isn’t a value at all”. Optionals are similar to using nil with pointers in Objective-C, but they work for any type, not just classes. Optionals are safer and more expressive than nil pointers in Objective-C and are at the heart of many of Swift’s most powerful features.</p>
<p>Optionals are an example of the fact that Swift is a type safe language. Swift helps you to be clear about the types of values your code can work with. If part of your code expects a String, type safety prevents you from passing it an Int by mistake. This enables you to catch and fix errors as early as possible in the development process.</p>
<p>不允许nil, 就避免了在这个变量上操作的unexpected behavior。<br>但还是得有个方法来表示空值啊，于是就有了Optional，Optional就代表这个变量(比如NSArray)可以装两种东西，一种是nil, 一种是自己的类型（NSArray)。<br>Optional 背后是类似这样的东西（经过了语法糖包装的）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Optional : NilLiteralConvertible &#123;</div><div class="line">  <span class="keyword">case</span> None</div><div class="line">  <span class="keyword">case</span> Some(T)</div><div class="line">&#125;</div><div class="line"><span class="comment">// Int? 已经不是Int 而是Optional&lt;Int&gt; ...</span></div><div class="line">var height: Optional&lt;Int&gt; = Optional&lt;Int&gt;(<span class="number">180</span>)</div></pre></td></tr></table></figure>
<h4 id="如何使用-Optional-变量"><a href="#如何使用-Optional-变量" class="headerlink" title="如何使用 Optional 变量"></a>如何使用 Optional 变量</h4><p>简单讲就是，如果你确定一定有值，那么就用！<br>如果你不确定，而且不在乎没有值的情况，用？<br>要handle 没有值的情况，用if let</p>
<p>! 很好理解<br>？一个例子就是，你可能有一个navigationController。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">controller.navigationController?.pushViewController(myViewController, animated: <span class="literal">true</span>)</div></pre></td></tr></table></figure></p>
<p>你想用它来push 一个view 且只当它存在才push。如果navController 存在，这一句就会执行，不然整句都会被当成nil</p>
<p>if let 允许你这样写<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> let nav = controller.navigationController &#123;</div><div class="line">    nav.pushViewController(myViewController, animated: <span class="literal">true</span>)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//show an alert ot something else</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars2.githubusercontent.com/u/3442641?v=3&s=460"
               alt="lxian2" />
          <p class="site-author-name" itemprop="name">lxian2</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lxian2</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lxian-github-io"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  










  
  

  

  

  

  


</body>
</html>
